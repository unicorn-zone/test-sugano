<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1 id = "month_op"></h1>

  <div class="invite">
    招待コード： <div id="invite_code_op"></div>
    <button id="invite_toggle"></button>
  </div>



  <!-- モーダルエリアここから -->
  <section id="modalArea_group" class="modalArea">
    <div id="modalBg_group" class="modalBg"></div>
    <div class="modalWrapper">
      <div class="modalContents">
        <h1 id="modalH_group">初期設定</h1>

        <button id="create_calendar">新しくカレンダーを作る</button>

        <p>―――――――――――――――――――</p>

        <p>招待コードで参加する</p>
        <input id="invite_code_ip" type="text" />
        <button id="join_calendar">参加する</button>
      </div>
    </div>
  </section>
  <!-- モーダルエリアここまで -->

  <!-- ↓body閉じタグ直前でjQueryを読み込む -->
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>



  <input id="comment_ip" type="text" placeholder="予定の内容" />
  <input id="sche_start_ip" type="datetime-local" />
  <!-- <input id="sche_end_ip" type="datetime-local" /> -->
  <button id="submit">送信</button>
  <button id="update">更新</button>
  <button id="back"><前の月</button>
  <button id="next">次の月></button>
  <div id = "comment_op"></div>
  <div id = "result_op"></div>

  <table class="calendar">
    <tr>
      <th class="sunday">日</th> <th>月</th> <th>火</th> <th>水</th> <th>木</th> <th>金</th> <th class="saturday">土</th>
    </tr>
    <tr>
      <td>
        
        <table class="day">
          <tr>
            <th><div id = "d1" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th1_1"><div id = "n1_1"></div><div id = "c1_1"></div></th>
          </tr>
          <tr>
            <th id = "th1_2"><div id = "n1_2"></div><div id = "c1_2"></div></th>
          </tr>
        </table>


      </td>
      <td>
        

        <table class="day">
          <tr>
            <th><div id = "d2" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th2_1"><div id = "n2_1"></div><div id = "c2_1"></div></th>
          </tr>
          <tr>
            <th id = "th2_2"><div id = "n2_2"></div><div id = "c2_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d3" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th3_1"><div id = "n3_1"></div><div id = "c3_1"></div></th>
          </tr>
          <tr>
            <th id = "th3_2"><div id = "n3_2"></div><div id = "c3_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d4" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th4_1"><div id = "n4_1"></div><div id = "c4_1"></div></th>
          </tr>
          <tr>
            <th id = "th4_2"><div id = "n4_2"></div><div id = "c4_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d5" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th5_1"><div id = "n5_1"></div><div id = "c5_1"></div></th>
          </tr>
          <tr>
            <th id = "th5_2"><div id = "n5_2"></div><div id = "c5_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d6" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th6_1"><div id = "n6_1"></div><div id = "c6_1"></div></th>
          </tr>
          <tr>
            <th id = "th6_2"><div id = "n6_2"></div><div id = "c6_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d7" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th7_1"><div id = "n7_1"></div><div id = "c7_1"></div></th>
          </tr>
          <tr>
            <th id = "th7_2"><div id = "n7_2"></div><div id = "c7_2"></div></th>
          </tr>
        </table>


      </td>
    </tr>


    <tr>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d8" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th8_1"><div id = "n8_1"></div><div id = "c8_1"></div></th>
          </tr>
          <tr>
            <th id = "th8_2"><div id = "n8_2"></div><div id = "c8_2"></div></th>
          </tr>
        </table>


      </td>
      <td>
        

        <table class="day">
          <tr>
            <th><div id = "d9" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th9_1"><div id = "n9_1"></div><div id = "c9_1"></div></th>
          </tr>
          <tr>
            <th id = "th9_2"><div id = "n9_2"></div><div id = "c9_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d10" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th10_1"><div id = "n10_1"></div><div id = "c10_1"></div></th>
          </tr>
          <tr>
            <th id = "th10_2"><div id = "n10_2"></div><div id = "c10_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d11" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th11_1"><div id = "n11_1"></div><div id = "c11_1"></div></th>
          </tr>
          <tr>
            <th id = "th11_2"><div id = "n11_2"></div><div id = "c11_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d12" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th12_1"><div id = "n12_1"></div><div id = "c12_1"></div></th>
          </tr>
          <tr>
            <th id = "th12_2"><div id = "n12_2"></div><div id = "c12_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d13" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th13_1"><div id = "n13_1"></div><div id = "c13_1"></div></th>
          </tr>
          <tr>
            <th id = "th13_2"><div id = "n13_2"></div><div id = "c13_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d14" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th14_1"><div id = "n14_1"></div><div id = "c14_1"></div></th>
          </tr>
          <tr>
            <th id = "th14_2"><div id = "n14_2"></div><div id = "c14_2"></div></th>
          </tr>
        </table>


      </td>
    </tr>


    <tr>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d15" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th15_1"><div id = "n15_1"></div><div id = "c15_1"></div></th>
          </tr>
          <tr>
            <th id = "th15_2"><div id = "n15_2"></div><div id = "c15_2"></div></th>
          </tr>
        </table>


      </td>
      <td>
        

        <table class="day">
          <tr>
            <th><div id = "d16" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th16_1"><div id = "n16_1"></div><div id = "c16_1"></div></th>
          </tr>
          <tr>
            <th id = "th16_2"><div id = "n16_2"></div><div id = "c16_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d17" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th17_1"><div id = "n17_1"></div><div id = "c17_1"></div></th>
          </tr>
          <tr>
            <th id = "th17_2"><div id = "n17_2"></div><div id = "c17_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d18" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th18_1"><div id = "n18_1"></div><div id = "c18_1"></div></th>
          </tr>
          <tr>
            <th id = "th18_2"><div id = "n18_2"></div><div id = "c18_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d19" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th19_1"><div id = "n19_1"></div><div id = "c19_1"></div></th>
          </tr>
          <tr>
            <th id = "th19_2"><div id = "n19_2"></div><div id = "c19_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d20" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th20_1"><div id = "n20_1"></div><div id = "c20_1"></div></th>
          </tr>
          <tr>
            <th id = "th20_2"><div id = "n20_2"></div><div id = "c20_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d21" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th21_1"><div id = "n21_1"></div><div id = "c21_1"></div></th>
          </tr>
          <tr>
            <th id = "th21_2"><div id = "n21_2"></div><div id = "c21_2"></div></th>
          </tr>
        </table>


      </td>
    </tr>
    <tr>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d22" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th22_1"><div id = "n22_1"></div><div id = "c22_1"></div></th>
          </tr>
          <tr>
            <th id = "th22_2"><div id = "n22_2"></div><div id = "c22_2"></div></th>
          </tr>
        </table>


      </td>
      <td>
        

        <table class="day">
          <tr>
            <th><div id = "d23" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th23_1"><div id = "n23_1"></div><div id = "c23_1"></div></th>
          </tr>
          <tr>
            <th id = "th23_2"><div id = "n23_2"></div><div id = "c23_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th>
              
              <div id = "d24" class = "daynum"></div>

              <!-- モーダルエリアここから -->
              <section id="modalArea24" class="modalArea">
                <div id="modalBg24" class="modalBg"></div>
                <div class="modalWrapper">
                  <div class="modalContents">
                    <h1 id="modalH24"></h1>
                    <nobr id="delete24_1_temp"><button id="delete24_1" type="button" >削除</button></nobr> <nobr id="modalP24_1"></nobr><br>
                    <nobr id="delete24_2_temp"><button id="delete24_2" type="button" >削除</button></nobr> <nobr id="modalP24_2"></nobr><br>
                    <nobr id="delete24_3_temp"><button id="delete24_3" type="button" >削除</button></nobr> <nobr id="modalP24_3"></nobr><br>
                    <nobr id="delete24_4_temp"><button id="delete24_4" type="button" >削除</button></nobr> <nobr id="modalP24_4"></nobr><br>
                    <nobr id="delete24_5_temp"><button id="delete24_5" type="button" >削除</button></nobr> <nobr id="modalP24_5"></nobr>
                  </div>
                  <div id="closeModal24" class="closeModal">
                    ×
                  </div>
                </div>
              </section>
              <!-- モーダルエリアここまで -->

              <!-- ↓body閉じタグ直前でjQueryを読み込む -->
              <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

            </th>
          </tr>
          <tr>
            <th id = "th24_1"><div id = "n24_1"></div><div id = "c24_1"></div></th>
          </tr>
          <tr>
            <th id = "th24_2"><div id = "n24_2"></div><div id = "c24_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th>
              
              <div id = "d25" class = "daynum"></div>

              <!-- モーダルエリアここから -->
              <section id="modalArea25" class="modalArea">
                <div id="modalBg25" class="modalBg"></div>
                <div class="modalWrapper">
                  <div class="modalContents">
                    <h1 id="modalH25"></h1>
                    <nobr id="delete25_1_temp"><button id="delete25_1" type="button" >削除</button></nobr> <nobr id="modalP25_1"></nobr><br>
                    <nobr id="delete25_2_temp"><button id="delete25_2" type="button" >削除</button></nobr> <nobr id="modalP25_2"></nobr><br>
                    <nobr id="delete25_3_temp"><button id="delete25_3" type="button" >削除</button></nobr> <nobr id="modalP25_3"></nobr><br>
                    <nobr id="delete25_4_temp"><button id="delete25_4" type="button" >削除</button></nobr> <nobr id="modalP25_4"></nobr><br>
                    <nobr id="delete25_5_temp"><button id="delete25_5" type="button" >削除</button></nobr> <nobr id="modalP25_5"></nobr>
                  </div>
                  <div id="closeModal25" class="closeModal">
                    ×
                  </div>
                </div>
              </section>
              <!-- モーダルエリアここまで -->

              <!-- ↓body閉じタグ直前でjQueryを読み込む -->
              <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

            </th>
          </tr>
          <tr>
            <th id = "th25_1"><div id = "n25_1"></div><div id = "c25_1"></div></th>
          </tr>
          <tr>
            <th id = "th25_2"><div id = "n25_2"></div><div id = "c25_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th>
              
              <div id = "d26" class = "daynum"></div>

              <!-- モーダルエリアここから -->
              <section id="modalArea26" class="modalArea">
                <div id="modalBg26" class="modalBg"></div>
                <div class="modalWrapper">
                  <div class="modalContents">
                    <h1 id="modalH26"></h1>
                    <nobr id="delete26_1_temp"><button id="delete26_1" type="button" >削除</button></nobr> <nobr id="modalP26_1"></nobr><br>
                    <nobr id="delete26_2_temp"><button id="delete26_2" type="button" >削除</button></nobr> <nobr id="modalP26_2"></nobr><br>
                    <nobr id="delete26_3_temp"><button id="delete26_3" type="button" >削除</button></nobr> <nobr id="modalP26_3"></nobr><br>
                    <nobr id="delete26_4_temp"><button id="delete26_4" type="button" >削除</button></nobr> <nobr id="modalP26_4"></nobr><br>
                    <nobr id="delete26_5_temp"><button id="delete26_5" type="button" >削除</button></nobr> <nobr id="modalP26_5"></nobr>
                  </div>
                  <div id="closeModal26" class="closeModal">
                    ×
                  </div>
                </div>
              </section>
              <!-- モーダルエリアここまで -->

              <!-- ↓body閉じタグ直前でjQueryを読み込む -->
              <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
            
            </th>
          </tr>
          <tr>
            <th id = "th26_1"><div id = "n26_1"></div><div id = "c26_1"></div></th>
          </tr>
          <tr>
            <th id = "th26_2"><div id = "n26_2"></div><div id = "c26_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d27" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th27_1"><div id = "n27_1"></div><div id = "c27_1"></div></th>
          </tr>
          <tr>
            <th id = "th27_2"><div id = "n27_2"></div><div id = "c27_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d28" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th28_1"><div id = "n28_1"></div><div id = "c28_1"></div></th>
          </tr>
          <tr>
            <th id = "th28_2"><div id = "n28_2"></div><div id = "c28_2"></div></th>
          </tr>
        </table>


      </td>
    </tr>
    <tr>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d29" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th29_1"><div id = "n29_1"></div><div id = "c29_1"></div></th>
          </tr>
          <tr>
            <th id = "th29_2"><div id = "n29_2"></div><div id = "c29_2"></div></th>
          </tr>
        </table>


      </td>
      <td>
        

        <table class="day">
          <tr>
            <th><div id = "d30" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th30_1"><div id = "n30_1"></div><div id = "c30_1"></div></th>
          </tr>
          <tr>
            <th id = "th30_2"><div id = "n30_2"></div><div id = "c30_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d31" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th31_1"><div id = "n31_1"></div><div id = "c31_1"></div></th>
          </tr>
          <tr>
            <th id = "th31_2"><div id = "n31_2"></div><div id = "c31_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d32" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th32_1"><div id = "n32_1"></div><div id = "c32_1"></div></th>
          </tr>
          <tr>
            <th id = "th32_2"><div id = "n32_2"></div><div id = "c32_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d33" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th33_1"><div id = "n33_1"></div><div id = "c33_1"></div></th>
          </tr>
          <tr>
            <th id = "th33_2"><div id = "n33_2"></div><div id = "c33_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d34" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th34_1"><div id = "n34_1"></div><div id = "c34_1"></div></th>
          </tr>
          <tr>
            <th id = "th34_2"><div id = "n34_2"></div><div id = "c34_2"></div></th>
          </tr>
        </table>


      </td>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d35" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th35_1"><div id = "n35_1"></div><div id = "c35_1"></div></th>
          </tr>
          <tr>
            <th id = "th35_2"><div id = "n35_2"></div><div id = "c35_2"></div></th>
          </tr>
        </table>


      </td>
    </tr>
    <tr>
      <td>


        <table class="day">
          <tr>
            <th><div id = "d36" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th36_1"><div id = "n36_1"></div><div id = "c36_1"></div></th>
          </tr>
          <tr>
            <th id = "th36_2"><div id = "n36_2"></div><div id = "c36_2"></div></th>
          </tr>
        </table>


      </td>
      <td>
        

        <table class="day">
          <tr>
            <th><div id = "d37" class = "daynum"></div></th>
          </tr>
          <tr>
            <th id = "th37_1"><div id = "n37_1"></div><div id = "c37_1"></div></th>
          </tr>
          <tr>
            <th id = "th37_2"><div id = "n37_2"></div><div id = "c37_2"></div></th>
          </tr>
        </table>


      </td>
    </tr>
  </table>

  <script type="module">
    let ScheAmountPerDay = 5

    let group;
    let username;
    let colorID;
    let d = new Date();
    let year = d.getFullYear();
    let month = d.getMonth() + 1;
    let month_str = ('00' + month).slice(-2);
    let time = `${year}-${month_str}`;
    let monthLen = [ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 ];
    const MAXSLOT = 37;
    const DEF_COLOR = "#d4ff5f";

    // 指定した年、月を引数に入れると、月曜日からのズレを計算する。
    // 戻り値が0の場合は日曜日、1の場合は月曜日、6の場合は土曜日。
    function ZureCalendar(y, m){
      let dates = [];
      let zure, i;
      let monthLen_tmp = monthLen;

      zure = (y - 1) * 365;
      zure = zure + y / 4;
      zure = zure + y / 400;
      zure = zure - y / 100;
      zure = zure % 7;
      
      if (y % 400 == 0) {
        monthLen_tmp[1]++;
        zure--;
      } else if (y % 4 == 0 && y % 100 != 0) {
        monthLen_tmp[1]++;
        zure--;
      }

      if (m >= 2) {
        for (i = 0; i < m - 1; i++) {
          zure = zure + monthLen_tmp[i];
        }
        zure = zure % 7;
      }

      zure = Math.floor(zure);

      //このままでは月曜日基準のzureなので、日曜日基準のzureに変える。
      zure++;
      if (zure >= 7){
        zure = 0;
      }

      return zure;
    }

    // ZureCalendar関数によって得たズレを引数に入れると、日付と曜日が一致した、
    // カレンダーの一番左上のマス（日曜日）を添字0とする配列が戻り値となる。
    function MannnenCalendar(zure){
      let dates = [];
      let i;
      let monthLen_tmp = monthLen;

      for (i = 0; i < zure; i++) {
        dates[dates.length] = "";
      }

      for (i = 1; i <= monthLen[month - 1]; i++) {
        dates[dates.length] = i;
      }

      if (dates.length != MAXSLOT){
        i = 36;
        while (dates[i] === undefined){
          dates[i] = "";
          i--;
        }
      }

      return dates;
    }

    // time変数の年月の予定を取得し、output_d,n,c関数によって出力する。
    async function reload(){
      const response = await fetch("/download_month", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ group, time })
      });
      let result = await response.text();
      if (result != 'Database Error'){

        // 初期化
        for (let i = 0; i < MAXSLOT; i++) {
          document.getElementById(`n${i + 1}_1`).textContent = "";
          document.getElementById(`n${i + 1}_2`).textContent = "";
          document.getElementById(`th${i + 1}_1`).style.backgroundColor = DEF_COLOR;
          document.getElementById(`th${i + 1}_2`).style.backgroundColor = DEF_COLOR;
          document.getElementById(`c${i + 1}_1`).textContent = ""
          document.getElementById(`c${i + 1}_2`).textContent = ""
        }

        let zure = ZureCalendar(year, month);
        let dates = MannnenCalendar(zure);
        let flags = new Array(MAXSLOT).fill(true);

        let data = result.split('@@');
        for (let i = 0; i < data.length-1; i++) {
          let data2 = data[i].split('||');
          let id = data2[0];
          let created_at = data2[1];
          let user = data2[2];
          let color = data2[3];
          let sche_start = data2[4];
          let sche_end = data2[5];
          let comment = data2[6];

          let temp = sche_start.split('T');
          let temp2 = temp[0].split('-');
          let slot = Number(temp2[2]) + zure;

          console.log(color);

          if (flags[slot] == true){
            document.getElementById(`n${slot}_1`).textContent = user
            document.getElementById(`th${slot}_1`).style.backgroundColor = `${color}`
            document.getElementById(`c${slot}_1`).textContent = comment
            flags[slot] = false;
            
          }else{
            document.getElementById(`n${slot}_2`).textContent = document.getElementById(`n${slot}_1`).textContent
            document.getElementById(`n${slot}_1`).textContent = user
            
            document.getElementById(`th${slot}_2`).style.backgroundColor = document.getElementById(`th${slot}_1`).style.backgroundColor
            document.getElementById(`th${slot}_1`).style.backgroundColor = `${color}`

            document.getElementById(`c${slot}_2`).textContent = document.getElementById(`c${slot}_1`).textContent
            document.getElementById(`c${slot}_1`).textContent = comment
          }
        }

        for (let i = 0; i < dates.length; i++) {
          document.getElementById(`d${i + 1}`).textContent = dates[i]
        }
        
        month_op.textContent = year + "年 " + month + "月の予定";





        const response_invite = await fetch("/invite_check", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ group })
        });
        let result_invite = await response_invite.text();

        if (result_invite == -1){
          invite_code_op.textContent = ""
          invite_toggle.textContent = "有効にする"
        }else{
          invite_code_op.textContent = result_invite
          invite_toggle.textContent = "リセット＆無効にする"
        }

        return true;
        
      }else{
        return false;
      }
    }













    window.onload = async (event) => {
      const response = await fetch("/login"); // GET
      let result = await response.text();
      let data = result.split('@@');
      username = data[0];
      group = data[1];
      colorID = data[2];

      let result_reload = await reload();
      
      if (result_reload == false){
        $('#modalArea_group').fadeIn(200); // ポップアップを表示

      }else{
        await reload();
      }
    }

    document.querySelector("#create_calendar").onclick = async (event) => {
      const response_invite = await fetch("/create_calendar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      let result = await response_invite.text();

      if (result == -1){
        alert("新しくカレンダーを作れませんでした。運営に相談してください");

      }else{
        group = result;
        await reload();
        $('#modalArea_group').fadeOut(200);
      }
    }

    document.querySelector("#join_calendar").onclick = async (event) => {
      let invite_code = invite_code_ip.value;
      const response_invite = await fetch("/join_calendar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, invite_code })
      });
      let result = await response_invite.text();
      
      if (result == -1){
        alert("招待コードが無効です");

      }else{
        group = result;
        await reload();
        $('#modalArea_group').fadeOut(200);
      }
    }

    document.querySelector("#update").onclick = async (event) => {
      await reload();
    }

    document.querySelector("#back").onclick = async (event) => {
      month--;
      if (month < 1) {
        year--;
        month = 12;
      }
      month_str = ('00' + month).slice(-2);
      time = `${year}-${month_str}`;
      await reload();
    }

    document.querySelector("#next").onclick = async (event) => {
      month++;
      if (month > 12) {
        year++;
        month = 1;
      }
      month_str = ('00' + month).slice(-2);
      time = `${year}-${month_str}`;
      await reload();
    }

    document.querySelector("#submit").onclick = async (event) => {
      let sche_start = document.querySelector("#sche_start_ip").value;
      //let sche_end = document.querySelector("#sche_end_ip").value;
      let sche_end = document.querySelector("#sche_start_ip").value;
      let comment = document.querySelector("#comment_ip").value;

      if (comment.includes('||') || comment.includes('@@')){
        alert('使用できない記号が含まれています');
      }else{

        if (sche_start == ""){
          alert("日付を設定してください");
        }else{

          if (sche_end == ""){
            sche_end = sche_start;
          }

          let temp = sche_start.split('T');
          let temp2 = temp[0].split('-');
          let day = time + "-" + temp2[2];
          const response_check_day_amount = await fetch("/check_day_amount", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ group, day })
          });
          let amount = await response_check_day_amount.text();
          result_op.textContent = amount;

          if (Number(amount) < 5){
            const response_send = await fetch("/send", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ group, username, colorID, sche_start, sche_end, comment })
            });
            let result = await response_send.text();
            await reload();

          }
        }
      }
    }

    document.querySelector("#invite_toggle").onclick = async (event) => {
      if (invite_toggle.textContent == "有効にする"){
        let chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let rand_str = '';
        for ( var i = 0; i < 8; i++ ) {
          rand_str += chars.charAt(Math.floor(Math.random() * chars.length));
        }

        const response = await fetch("/invite_enable", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rand_str, group })
        });
        let result = await response.text();
        console.log(result);

        if (result == 0){
          invite_code_op.textContent = rand_str
        }else{
          invite_code_op.textContent = result
        }

        invite_toggle.textContent = "リセット＆無効にする"




      }else{
        const response = await fetch("/invite_disable", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ group })
        });

        invite_code_op.textContent = ""
        invite_toggle.textContent = "有効にする"
      }
    }





















    async function popup_day(slot){
      let date = document.getElementById("d" + slot).textContent;
      let day = time + "-" + ('00' + date).slice(-2);
      const response = await fetch("/download_day", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ group, day })
      });
      let result = await response.text();
      document.getElementById("modalH" + slot).innerHTML = `${month}月${date}日の予定一覧`;

      let data = result.split('@@');
      
      let ids = [];
      let created_ats = [];
      let users = [];
      let colors = [];
      let sche_starts = [];
      let sche_start_hours = [];
      let sche_start_minutes = [];
      let sche_starts_op = [];
      let sche_ends = [];
      let sche_end_hours = [];
      let sche_end_minutes = [];
      let comments = [];

      let i, j, k;
      for (i = 0; i < data.length-1; i++) { // 取得したデータを変数に格納
        let data2 = data[i].split('||');
        ids[ids.length] = data2[0];
        created_ats[created_ats.length] = data2[1];
        users[users.length] = data2[2];
        colors[users.length] = data2[3];
        sche_starts[sche_starts.length] = data2[4];
        sche_ends[sche_ends.length] = data2[5];
        comments[comments.length] = data2[6];

        let temp = sche_starts[i].split('T');
        let temp2 = temp[1].split(':');
        sche_start_hours[sche_start_hours.length] = Number(temp2[0]);
        sche_start_minutes[sche_start_minutes.length] = Number(temp2[1]);

        sche_starts_op[sche_starts_op.length] = temp2[0] + ":" + temp2[1];
      }

      




      // 時間順に整理する機構
      let indexes = [];

      for (i = 0; i < sche_start_hours.length; i++){

        // まずは時単位だけで比較
        let minHour = 99, minHourIndex = 99;
        for (j = 0; j < sche_start_hours.length; j++){
          if (indexes.length == 0 || sche_start_hours[indexes[indexes.length - 1]] < sche_start_hours[j]){
            if (minHour > sche_start_hours[j]){
              minHour = sche_start_hours[j];
              minHourIndex = j;
            }
          }
        }


        // 時単位だけで同じ時間があるか調べる
        let sameDataIndexes = [];
        for (j = 0; j < sche_start_hours.length; j++){
          if (minHour == sche_start_hours[j]){
            sameDataIndexes[sameDataIndexes.length] = j;
          }
        }

        // 時単位だけで同じ時間がなかったら、次の時間へGO
        if (sameDataIndexes.length == 1){
          indexes[indexes.length] = sameDataIndexes[0];

        // あったら、それ同士を分単位で比較
        }else{

          let len = sameDataIndexes.length;
          for (j = 0; j < len; j++){
            let minMinute = 99, minMinuteIndex = 99, removeIndex = 99;
            for (k = 0; k < sameDataIndexes.length; k++){
              if (minMinute > sche_start_minutes[sameDataIndexes[k]]){
                minMinute = sche_start_minutes[sameDataIndexes[k]];
                minMinuteIndex = sameDataIndexes[k];
                removeIndex = k
              }
            }
            indexes[indexes.length] = minMinuteIndex;
            let temp1 = sameDataIndexes, temp2 = sameDataIndexes;
            temp1 = temp1.slice(0, removeIndex);
            temp2 = temp2.slice(removeIndex + 1);
            sameDataIndexes = temp1.concat(temp2);
          }
        }
      }




      for (i = 0; i < data.length-1; i++) {
        if (username == users[indexes[i]]){
          document.getElementById(`delete${slot}_${i + 1}_temp`).style.visibility = 'visible';
        }else{
          document.getElementById(`delete${slot}_${i + 1}_temp`).style.visibility = 'hidden';
        }

        document.getElementById(`modalP${slot}_${i + 1}`).innerHTML = `<nobr hidden>${ids[indexes[i]]}</nobr> ${sche_starts_op[indexes[i]]} ${users[indexes[i]]}: ${comments[indexes[i]]}`; // 本文を書き、表示する
      }

      for (i = i; i < ScheAmountPerDay; i++) {
        document.getElementById(`delete${slot}_${i + 1}_temp`).style.visibility = 'hidden';
        document.getElementById(`modalP${slot}_${i + 1}`).innerHTML = ""; // 本文を初期化し、非表示にする
      }
    }


    async function deleteSche(slot, index){
      let data = document.getElementById(`modalP${slot}_${index}`).textContent
      let data2 = data.split(' ');
      let id = data2[0];
      
      if (id != undefined){
        const response = await fetch("/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id })
        });
        let result = await response.text();
        result_op.textContent = result;
        await popup_day(slot);
        await reload();
      }
    }


    // 日付をクリックでpopup関数が起動
    $(function () {
      $('#d24').click(async function(){ await popup_day(24); $('#modalArea24').fadeIn(200); });
      $('#closeModal24 , #modalBg24').click(function(){ $('#modalArea24').fadeOut(200); });

      $('#d25').click(async function(){ await popup_day(25); $('#modalArea25').fadeIn(200); });
      $('#closeModal25 , #modalBg25').click(function(){ $('#modalArea25').fadeOut(200); });
      
      $('#d26').click(async function(){ await popup_day(26); $('#modalArea26').fadeIn(200); });
      $('#closeModal26 , #modalBg26').click(function(){ $('#modalArea26').fadeOut(200); });


    });



    // ポップアップの削除ボタンを押すとdeleteSche関数が起動
    document.querySelector("#delete24_1").onclick = async (event) => { await deleteSche(24, 1) };
    document.querySelector("#delete24_2").onclick = async (event) => { await deleteSche(24, 2) };
    document.querySelector("#delete24_3").onclick = async (event) => { await deleteSche(24, 3) };
    document.querySelector("#delete24_4").onclick = async (event) => { await deleteSche(24, 4) };
    document.querySelector("#delete24_5").onclick = async (event) => { await deleteSche(24, 5) };

    document.querySelector("#delete25_1").onclick = async (event) => { await deleteSche(25, 1) };
    document.querySelector("#delete25_2").onclick = async (event) => { await deleteSche(25, 2) };
    document.querySelector("#delete25_3").onclick = async (event) => { await deleteSche(25, 3) };
    document.querySelector("#delete25_4").onclick = async (event) => { await deleteSche(25, 4) };
    document.querySelector("#delete25_5").onclick = async (event) => { await deleteSche(25, 5) };

    document.querySelector("#delete26_1").onclick = async (event) => { await deleteSche(26, 1) };
    document.querySelector("#delete26_2").onclick = async (event) => { await deleteSche(26, 2) };
    document.querySelector("#delete26_3").onclick = async (event) => { await deleteSche(26, 3) };
    document.querySelector("#delete26_4").onclick = async (event) => { await deleteSche(26, 4) };
    document.querySelector("#delete26_5").onclick = async (event) => { await deleteSche(26, 5) };
    
  </script>

</body>

</html>